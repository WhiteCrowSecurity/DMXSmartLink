{% extends "base.html" %}

{% block title %}DMXSmartLink Hub{% endblock %}

{% block content %}
  <div class="container">
  <h1>DMX Smart Link Management Dashboard</h1>
    
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-messages">
        {% for category, message in messages %}
            <div class="flash-message flash-{{ category }}">
              <strong>{{ category|title }}:</strong> {{ message }}
            </div>
        {% endfor %}
        </div>
    {% endif %}
  {% endwith %}

    <div class="card">
      <div class="status-label">Server Information</div>
      <div class="info-row" style="margin-bottom: 16px;">
        <span class="status-label" style="margin-bottom: 0;">Current IP:</span>
        <strong style="color: #ffffff; font-size: 1.1rem;">{{ server_ip if server_ip else 'Not available' }}</strong>
      </div>
      
      <div class="status-label" style="margin-top: 24px;">Art-Net Listener Status</div>
      <div class="info-row">
        <span class="status-badge {% if artnet_status == 'Running' %}status-running{% else %}status-stopped{% endif %}">
          {{ artnet_status }}
        </span>
        <a href="{{ url_for('groups_visual_control') }}" class="btn btn-control" style="margin-left: 12px;">üé® Visual Control</a>
      </div>
      
      <div class="status-label" style="margin-top: 24px;">DMX USB Device Status (Universe {{ dmx_usb_universe }})</div>
      <div class="info-row">
        <span class="status-badge {% if dmx_usb_status == 'Connected' %}status-running{% else %}status-stopped{% endif %}">
          {{ dmx_usb_status }}
        </span>
        {% if dmx_usb_status == 'Connected' and dmx_usb_device_info %}
          <span style="color: #a0a0a0; font-size: 0.85rem; margin-left: 12px;">
            <strong>{{ dmx_usb_device_info.description or 'FTDI USB-to-DMX Device' }}</strong>
            {% if dmx_usb_device_info.port %} | Port: {{ dmx_usb_device_info.port }}{% endif %}
            {% if dmx_usb_device_info.mode %} | Mode: {{ dmx_usb_device_info.mode }}{% endif %}
          </span>
        {% else %}
          <span style="color: #a0a0a0; font-size: 0.85rem; margin-left: 12px;">
            USB-to-DMX device not detected (Enttec Open DMX USB, DSD TECH SH-RS09B, Enttec DMX USB Pro, etc.)
          </span>
        {% endif %}
      </div>
      {% if dmx_usb_status == 'Connected' and dmx_usb_device_info %}
      <div style="margin-top: 12px; padding: 12px; background-color: #1a1a1a; border-radius: 8px; border: 1px solid #3b3b3b;">
        <div style="color: #a0a0a0; font-size: 0.85rem; line-height: 1.8;">
          <div><strong>Device:</strong> {{ dmx_usb_device_info.description or 'Unknown Device' }}</div>
          {% if dmx_usb_device_info.manufacturer %}<div><strong>Manufacturer:</strong> {{ dmx_usb_device_info.manufacturer }}</div>{% endif %}
          {% if dmx_usb_device_info.port %}<div><strong>Port:</strong> {{ dmx_usb_device_info.port }}</div>{% endif %}
          <div><strong>Universe:</strong> {{ dmx_usb_device_info.universe }}</div>
          {% if dmx_usb_device_info.mode %}<div><strong>Mode:</strong> {{ dmx_usb_device_info.mode }} ({% if dmx_usb_device_info.mode == 'input' %}XLR input port only{% elif dmx_usb_device_info.mode == 'output' %}XLR output port only{% else %}XLR input + output ports{% endif %})</div>{% endif %}
            {% if dmx_usb_device_info.vid_hex or dmx_usb_device_info.pid_hex %}<div><strong>USB ID:</strong> {% if dmx_usb_device_info.vid_hex %}VID: {{ dmx_usb_device_info.vid_hex }}{% endif %}{% if dmx_usb_device_info.vid_hex and dmx_usb_device_info.pid_hex %}, {% endif %}{% if dmx_usb_device_info.pid_hex %}PID: {{ dmx_usb_device_info.pid_hex }}{% endif %}</div>{% endif %}
        </div>
      </div>
      {% endif %}
      
      <div class="action-buttons">
        <a href="{{ url_for('start_artnet_route') }}" class="btn btn-control">Start Art-Net Listener</a>
        <a href="{{ url_for('stop_artnet_route') }}" class="btn btn-control">Stop Art-Net Listener</a>
        <a href="{{ url_for('artnet_output') }}" class="btn btn-control">View Art-Net Output</a>
        <a href="{{ url_for('restart_dmx_usb_route') }}" class="btn btn-control">Restart DMX USB</a>
        <a href="{{ url_for('dmx_usb_debug') }}" class="btn btn-secondary">üîç Debug DMX USB Signals</a>
      </div>
      
      <div class="action-buttons" style="margin-top: 12px;">
        <a href="{{ url_for('config_view') }}" class="btn">Manage Config</a>
        <a href="{{ url_for('refresh_inventory_route') }}" class="btn">Refresh All Inventories</a>
        <a href="{{ url_for('devices_view') }}" class="btn btn-secondary">View All Devices</a>
      </div>
      
      <div class="action-buttons" style="margin-top: 12px;">
        <a href="{{ url_for('groups_view') }}" class="btn">Manage Groups</a>
        <a href="{{ url_for('fixtures_view') }}" class="btn">Manage DMX Fixtures</a>
        <a href="{{ homebridge_url }}" target="_blank" class="btn btn-secondary">Homebridge UI</a>
        <a href="{{ url_for('reboot_os') }}" class="btn btn-danger" onclick="return confirm('Are you sure you want to reboot the system?');">Reboot OS</a>
      </div>
      
      <div class="action-buttons" style="margin-top: 12px;">
        <a href="https://dmxsmartlink.com/pages/contact" target="_blank" rel="noopener" class="btn btn-secondary">Contact Support</a>
        <a href="https://discord.gg/pj6f54dpv7" target="_blank" rel="noopener" class="btn btn-secondary" style="display: inline-flex; align-items: center; justify-content: center;">
          <img src="https://whitecrowsecurity.com/wp-content/uploads/2025/07/Discord-Logo-Blurple-scaled.png" alt="Discord" style="height:20px;" />
        </a>
      </div>
      
      <p style="color: #a0a0a0; font-size: 0.85rem; margin-top: 16px;">
        <strong>Note:</strong> Inventories from Homebridge and Home Assistant are automatically merged into one unified device list. Use "Refresh All Inventories" to update all devices.
      </p>
    </div>

    <div class="card">
      <div class="status-label">License Status</div>
      <div class="info-row" style="align-items: center;">
        {% if "Valid" in license_status %}
          <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background-color: #10b981; color: #ffffff; font-size: 16px; font-weight: bold; margin-right: 12px;">‚úì</span>
        {% else %}
          <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background-color: #ef4444; color: #ffffff; font-size: 16px; font-weight: bold; margin-right: 12px;">‚úó</span>
        {% endif %}
        <strong style="color: #ffffff;">{{ license_status }}</strong>
        <a href="https://dmxsmartlink.com/products/dmx-smart-link" target="_blank" class="btn" style="margin-left: auto;">Buy/Renew License</a>
      </div>
      {% if "Valid" in license_status %}
        <div class="action-buttons" style="margin-top: 12px;">
          <a href="{{ url_for('deactivate_license') }}" class="btn btn-secondary" onclick="return confirm('Are you sure you want to deactivate the license?');">Deactivate License</a>
        </div>
      {% endif %}
    </div>

    <div class="card">
      <h2 style="margin-top: 0;">14-Day Trial License</h2>
      <p style="color: #a0a0a0; margin-bottom: 20px;">Get a free 14-day trial license to test DMXSmartLink. Enter your email below to receive your trial license key.</p>
      
      <div style="text-align:center; margin-bottom:2rem;">
        <a
          href="https://dmxsmartlink.com/pages/7-day-free-trial"
          target="_blank"
          rel="noopener"
          class="btn"
          style="display:inline-block; padding:12px 24px; text-decoration:none;"
        >
          Get 14-Day Trial License
        </a>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-top: 0;">Updates</h2>
      {% set update_settings = update_settings %}
      <div class="info-row" style="margin-bottom: 20px; align-items: center;">
        <span class="status-label" style="margin-bottom: 0;">Auto-Update:</span>
        <label class="toggle-switch">
          <input type="checkbox" {% if update_settings.get('auto_update', True) %}checked{% endif %} 
                 onchange="window.location.href='{{ url_for('toggle_auto_update') }}'">
          <span class="toggle-slider"></span>
        </label>
        <span class="status-badge {% if update_settings.get('auto_update', True) %}status-running{% else %}status-stopped{% endif %}" style="margin-left: 8px;">
          {% if update_settings.get('auto_update', True) %}Enabled{% else %}Disabled{% endif %}
        </span>
        {% if update_settings.get('last_update_check') %}
          <span style="color: #a0a0a0; font-size: 0.9rem; margin-left: auto;">Last check: {{ update_settings.get('last_update_check') }}</span>
        {% endif %}
      </div>

      <div class="info-row" style="margin-bottom: 20px; align-items: center;">
        <span class="status-label" style="margin-bottom: 0;">Logging:</span>
        <label class="toggle-switch">
          <input type="checkbox" {% if logging_settings.get('enabled', True) %}checked{% endif %}
                 onchange="window.location.href='{{ url_for('toggle_logging') }}'">
          <span class="toggle-slider"></span>
        </label>
        <span class="status-badge {% if logging_settings.get('enabled', True) %}status-running{% else %}status-stopped{% endif %}" style="margin-left: 8px;">
          {% if logging_settings.get('enabled', True) %}On{% else %}Off{% endif %}
        </span>
        <span style="color: #a0a0a0; font-size: 0.9rem; margin-left: auto;">Log UI shows last 1,000 lines (file retains 100,000).</span>
      </div>
      <div class="action-buttons">
        <a href="{{ url_for('perform_update_route') }}" class="btn" onclick="return confirm('This will update the software from GitHub. Continue?');">Update Now</a>
      </div>
      <p style="color: #a0a0a0; font-size: 0.85rem; margin-top: 12px;">
        Updates will preserve your configuration files (config.json, devices.json, groups.json, license files).
      </p>
    </div>

  </div>
{% endblock %}

