{% extends "base.html" %}

{% block title %}Groups - DMXSmartLink Hub{% endblock %}

{% block extra_head %}
  <script>
    function createGroup() {
      var groupName = document.getElementById("group_name").value;
      var universe = document.getElementById("universe").value;
      var channels = document.getElementById("channels").value;
      if (!groupName || universe === "" || !channels) {
        alert("Please fill in group name, universe, and 5 channels.");
        return;
      }
      var url = "/groups/create_link?group_name=" + encodeURIComponent(groupName) +
                "&universe=" + encodeURIComponent(universe) +
                "&channels=" + encodeURIComponent(channels);
      window.location.href = url;
    }
    function updateGroupParams(group) {
      var universe = document.getElementById("universe_" + group).value;
      var channels = document.getElementById("channels_" + group).value;
      if (universe === "" || !channels) {
        alert("Please fill in both universe and channels.");
        return;
      }
      var url = "/groups/" + encodeURIComponent(group) +
                "/update_parameters_link?universe=" + encodeURIComponent(universe) +
                "&channels=" + encodeURIComponent(channels);
      window.location.href = url;
    }
    function toggleSelectAll(group) {
      var selectAllCheckbox = document.getElementById("select_all_" + group);
      var checkboxes = document.querySelectorAll(".device_in_this_group_checkbox_" + group);
      checkboxes.forEach(function(cb) {
        cb.checked = selectAllCheckbox.checked;
      });
      }
    
    function updateSelectAllCheckbox(group) {
      var checkboxes = document.querySelectorAll(".device_in_this_group_checkbox_" + group);
      var selectAllCheckbox = document.getElementById("select_all_" + group);
      if (selectAllCheckbox) {
        var allChecked = Array.from(checkboxes).every(function(cb) { return cb.checked; });
        var someChecked = Array.from(checkboxes).some(function(cb) { return cb.checked; });
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked && !allChecked;
    }
    }
    
    function removeSelectedDevicesFromThisGroup(group) {
      var checkboxes = document.querySelectorAll(".device_in_this_group_checkbox_" + group);
      var selectedPositions = [];
      checkboxes.forEach(function(cb) {
        if (cb.checked) {
          selectedPositions.push(cb.value);
        }
      });
      if (selectedPositions.length === 0) {
        alert("Please select at least one device to remove from group " + group);
        return;
      }
      var url = "/groups/" + encodeURIComponent(group) +
                "/remove_by_index?device_number=" + encodeURIComponent(selectedPositions.join(","));
      fetch(url)
        .then(response => response.text())
        .then(data => {
          console.log("Removed devices from group", group, data);
          alert("Removal request sent. Please refresh the page to see updates.");
          window.location.reload();
        })
        .catch(err => console.error("Error:", err));
    }
  </script>
{% endblock %}

{% block content %}
  <div class="container">
    <a href="{{ url_for('index') }}" class="back-link">‚Üê Back to Dashboard</a>
    <h1>Groups</h1>
    
    <div class="card">
      <div class="action-buttons" style="margin-bottom: 20px;">
        <a href="{{ url_for('groups_visual_control') }}" class="btn btn-control" style="font-size: 1rem; padding: 14px 24px;">üé® Visual Control</a>
      </div>
      <h2 style="margin-top: 0;">Create New Group</h2>
      <p style="color: #a0a0a0; margin-bottom: 20px;">Create a group first, then add devices to it.</p>
      <form id="createGroupForm">
        <div class="form-group">
          <label for="group_name">Group Name:</label>
          <input type="text" id="group_name" placeholder="Group Name" required>
        </div>
        <div class="form-group">
          <label for="universe">Universe:</label>
          <input type="number" id="universe" placeholder="Universe" min="0" required>
        </div>
        <div class="form-group">
          <label for="channels">Channels (5 comma separated numbers):</label>
          <input type="text" id="channels" placeholder="e.g., 1,2,3,4,5" required>
        </div>
        <button type="button" onclick="createGroup()" class="btn">Create Group</button>
      </form>
    </div>

  {% for group, info in groups.items() %}
      {% if group != '_stage_layout' %}
      <div class="group-card">
        <div class="group-header">
          <h2 style="margin: 0;">Group: {{ group }}</h2>
        </div>
        <div class="group-info">
          <strong>Universe:</strong> {{ info.universe }} | <strong>Channels:</strong> {{ info.channels }}
        </div>
        
        <div class="device-list">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <strong style="color: #ffffff;">Devices in this group ({{ info.devices|length }} device(s)):</strong>
            {% if info.devices|length > 0 %}
              <label class="checkbox-label" style="margin: 0;">
                <input type="checkbox" id="select_all_{{ group }}" onchange="toggleSelectAll('{{ group }}')">
                Select All
              </label>
            {% endif %}
          </div>
          {% if info.devices|length > 0 %}
        {% for uuid in info.devices %}
              <div class="device-item checkbox-group">
                <input type="checkbox" class="device_in_this_group_checkbox_{{ group }}" value="{{ pos_lookup[uuid] }}" onchange="updateSelectAllCheckbox('{{ group }}')">
                <span><strong>{{ pos_lookup[uuid] }}.</strong> {{ devices.get(uuid, {}).get("name", "Unknown") }}</span>
                <span class="status-badge status-running" style="margin-left: 8px; font-size: 0.7rem;">
                  {{ devices.get(uuid, {}).get("provider", "unknown")|upper }}
                </span>
                <span style="color:#a0a0a0; font-size: 0.85rem; margin-left: 8px;">
                  {{ (devices.get(uuid, {}).get("meta", {}) or {}).get("model", devices.get(uuid, {}).get("model", "Unknown")) }}
                </span>
              </div>
        {% endfor %}
          {% else %}
            <p style="color: #a0a0a0; font-style: italic; margin: 12px 0;">No devices in this group yet. Click "Add Devices" to get started.</p>
          {% endif %}
        </div>
        
        <div class="action-buttons" style="margin-top: 16px;">
          <a href="{{ url_for('group_add_devices_view', group=group) }}" class="btn">Add Devices</a>
          {% if info.devices|length > 0 %}
            <button type="button" onclick="removeSelectedDevicesFromThisGroup('{{ group }}')" class="btn btn-secondary">
              Remove Selected
      </button>
          {% endif %}
          <a href="{{ url_for('delete_group_link', group=group) }}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete group {{ group }}?');">Delete Group</a>
        </div>
        
        <div class="card" style="margin-top: 20px; background-color: #1a1a1a;">
          <h3 style="margin-top: 0; margin-bottom: 16px;">Update Group Parameters</h3>
      <form onsubmit="return false;">
            <div class="form-group">
              <label for="universe_{{ group }}">Universe:</label>
              <input type="number" id="universe_{{ group }}" value="{{ info.universe|string }}" min="0">
            </div>
            <div class="form-group">
              <label for="channels_{{ group }}">Channels (5 comma separated numbers):</label>
              <input type="text" id="channels_{{ group }}" value="{{ info.channels }}" placeholder="e.g., 1,2,3,4,5">
            </div>
            <button type="button" onclick="updateGroupParams('{{ group }}')" class="btn">Update Group Parameters</button>
      </form>
        </div>
    </div>
      {% endif %}
  {% endfor %}
  
    {% set has_actual_groups = false %}
    {% for group_name in groups %}
      {% if group_name != '_stage_layout' %}
        {% set has_actual_groups = true %}
      {% endif %}
    {% endfor %}
    {% if not has_actual_groups %}
      <div class="card">
        <p style="color: #a0a0a0; text-align: center; padding: 40px 20px;">
          No groups yet. Create your first group above to get started.
        </p>
      </div>
    {% endif %}
  </div>
{% endblock %}

