{% extends "base.html" %}

{% block title %}Add Devices to {{ group_name }} - DMXSmartLink Hub{% endblock %}

{% block extra_head %}
  <script>
    var sortColumn = null;
    var sortDirection = 'asc';
    
    function toggleShowAll() {
      var checkbox = document.getElementById('show_all_devices');
      applyFilters();
    }
    
    function filterDevices() {
      applyFilters();
    }
    
    function applyFilters() {
      var searchText = document.getElementById('search_input').value.toLowerCase();
      var showAllCheckbox = document.getElementById('show_all_devices');
      var rows = document.querySelectorAll('.device-row');
      
      rows.forEach(function(row) {
        var isInCurrentGroup = row.dataset.inGroup === 'true';
        var name = row.dataset.deviceName.toLowerCase();
        var provider = row.dataset.deviceProvider.toLowerCase();
        var model = row.dataset.deviceModel.toLowerCase();
        var status = row.dataset.deviceStatus.toLowerCase();
        
        var matchesSearch = searchText === '' || 
                           name.includes(searchText) || 
                           provider.includes(searchText) || 
                           model.includes(searchText) || 
                           status.includes(searchText);
        
        var shouldShow = matchesSearch;
        if (isInCurrentGroup) {
          shouldShow = shouldShow && showAllCheckbox.checked;
        }
        
        row.style.display = shouldShow ? '' : 'none';
      });
    }
    
    function sortTable(column) {
      var tbody = document.querySelector('#devicesTable tbody');
      var rows = Array.from(tbody.querySelectorAll('.device-row'));
      
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      
      rows.sort(function(a, b) {
        var aVal, bVal;
        if (column === 'name') {
          aVal = a.dataset.deviceName.toLowerCase();
          bVal = b.dataset.deviceName.toLowerCase();
        } else if (column === 'provider') {
          aVal = a.dataset.deviceProvider.toLowerCase();
          bVal = b.dataset.deviceProvider.toLowerCase();
        } else if (column === 'model') {
          aVal = a.dataset.deviceModel.toLowerCase();
          bVal = b.dataset.deviceModel.toLowerCase();
        } else if (column === 'status') {
          aVal = a.dataset.deviceStatus.toLowerCase();
          bVal = b.dataset.deviceStatus.toLowerCase();
        }
        
        var comparison = 0;
        if (aVal > bVal) {
          comparison = 1;
        } else if (aVal < bVal) {
          comparison = -1;
        }
        
        return sortDirection === 'asc' ? comparison : -comparison;
      });
      
      rows.forEach(function(row) {
        tbody.appendChild(row);
      });
      
      updateSortIndicators();
      applyFilters();
    }
    
    function updateSortIndicators() {
      document.querySelectorAll('.sortable-header').forEach(function(header) {
        var column = header.dataset.column;
        var indicator = header.querySelector('.sort-indicator');
        if (sortColumn === column) {
          indicator.textContent = sortDirection === 'asc' ? ' ▲' : ' ▼';
        } else {
          indicator.textContent = '';
        }
      });
    }
    
    function addSelectedDevices() {
      var checkboxes = document.querySelectorAll('.device_checkbox:checked');
      if (checkboxes.length === 0) {
        alert('Please select at least one device to add.');
        return;
      }
      var deviceNumbers = Array.from(checkboxes).map(cb => cb.value);
      var url = '/groups/{{ group_name }}/add_by_index?device_number=' + encodeURIComponent(deviceNumbers.join(','));
      window.location.href = url;
    }
    
    window.onload = function() {
      applyFilters();
    };
  </script>
{% endblock %}

{% block content %}
  <div class="container">
    <a href="{{ url_for('groups_view') }}" class="back-link">← Back to Groups</a>
    <h1>Add Devices to Group: {{ group_name }}</h1>
    
    <div class="card">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
        <label class="checkbox-label" style="margin: 0;">
          <input type="checkbox" id="show_all_devices" onchange="toggleShowAll()">
          Show devices already in this group
        </label>
        <span style="color: #a0a0a0; font-size: 0.85rem; margin-left: auto;">
          Devices can be in multiple groups. Select any device to add it.
        </span>
      </div>
      
      <div style="margin-bottom: 16px;">
        <input type="text" id="search_input" placeholder="Search by name, provider, model, or status..." 
               style="width: 100%; padding: 10px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 4px; color: #ffffff; font-size: 0.9rem;"
               onkeyup="filterDevices()" oninput="filterDevices()">
      </div>
      
      <form id="devicesForm">
        <table id="devicesTable">
          <thead>
    <tr>
              <th style="width: 60px;">Select</th>
              <th style="width: 80px;">Position</th>
              <th class="sortable-header" data-column="name" onclick="sortTable('name')" style="cursor: pointer; user-select: none;">
                Name<span class="sort-indicator"></span>
              </th>
              <th class="sortable-header" data-column="provider" onclick="sortTable('provider')" style="cursor: pointer; user-select: none;">
                Provider<span class="sort-indicator"></span>
              </th>
              <th class="sortable-header" data-column="model" onclick="sortTable('model')" style="cursor: pointer; user-select: none;">
                Model<span class="sort-indicator"></span>
              </th>
              <th class="sortable-header" data-column="status" onclick="sortTable('status')" style="cursor: pointer; user-select: none;">
                Status<span class="sort-indicator"></span>
              </th>
    </tr>
          </thead>
          <tbody>
    {% for dev in enumerated_devices %}
      {% set uuid = dev[0] %}
      {% set details = dev[1] %}
              {% set in_group = uuid in group_device_uuids %}
              {% set in_other_group = uuid in other_groups_device_uuids %}
              {% set device_name = details.get("name", "Unknown") %}
              {% set device_provider = details.get("provider", "unknown")|upper %}
              {% set device_model = (details.get("meta", {}) or {}).get("model", details.get("model", "Unknown")) %}
              {% if in_group %}
                {% set device_status = "Already in this group" %}
              {% elif in_other_group %}
                {% set device_status = "In another group (can be added)" %}
              {% else %}
                {% set device_status = "Available" %}
              {% endif %}
              <tr class="device-row" 
                  data-in-group="{{ 'true' if in_group else 'false' }}" 
                  data-device-name="{{ device_name }}"
                  data-device-provider="{{ device_provider }}"
                  data-device-model="{{ device_model }}"
                  data-device-status="{{ device_status }}"
                  style="{{ 'display: none;' if in_group else '' }}">
                <td>
                  {% if not in_group %}
                    <input type="checkbox" class="device_checkbox" value="{{ loop.index }}">
                  {% else %}
                    <span style="color: #a0a0a0;">—</span>
                  {% endif %}
                </td>
                <td><strong>{{ loop.index }}</strong></td>
                <td>{{ device_name }}</td>
                <td>
                  <span class="status-badge status-running" style="font-size: 0.7rem;">
                    {{ device_provider }}
                  </span>
                </td>
                <td>{{ device_model }}</td>
                <td>
                  {% if in_group %}
                    <span style="color: #10b981; font-size: 0.85rem;">{{ device_status }}</span>
                  {% elif in_other_group %}
                    <span style="color: #f59e0b; font-size: 0.85rem;">{{ device_status }}</span>
                  {% else %}
                    <span style="color: #6366f1; font-size: 0.85rem;">{{ device_status }}</span>
                  {% endif %}
                </td>
      </tr>
    {% endfor %}
          </tbody>
  </table>
  </form>
      
      <div class="action-buttons" style="margin-top: 24px;">
        <button type="button" onclick="addSelectedDevices()" class="btn">Add Selected Devices</button>
        <a href="{{ url_for('groups_view') }}" class="btn btn-secondary">Cancel</a>
      </div>
    </div>
  </div>
{% endblock %}

