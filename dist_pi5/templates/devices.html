{% extends "base.html" %}

{% block title %}Devices - DMXSmartLink Hub{% endblock %}

{% block extra_head %}
  <script>
    var sortColumn = null;
    var sortDirection = 'asc';
    
    function filterDevices() {
      var searchText = document.getElementById('search_input').value.toLowerCase();
      var rows = document.querySelectorAll('.device-row');
      
      rows.forEach(function(row) {
        var name = row.dataset.deviceName.toLowerCase();
        var provider = row.dataset.deviceProvider.toLowerCase();
        var model = row.dataset.deviceModel.toLowerCase();
        var deviceId = row.dataset.deviceId.toLowerCase();
        
        var matchesSearch = searchText === '' || 
                           name.includes(searchText) || 
                           provider.includes(searchText) || 
                           model.includes(searchText) || 
                           deviceId.includes(searchText);
        
        row.style.display = matchesSearch ? '' : 'none';
      });
    }
    
    function sortTable(column) {
      var tbody = document.querySelector('#devicesTable tbody');
      var rows = Array.from(tbody.querySelectorAll('.device-row'));
      
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      
      rows.sort(function(a, b) {
        var aVal, bVal;
        if (column === 'name') {
          aVal = a.dataset.deviceName.toLowerCase();
          bVal = b.dataset.deviceName.toLowerCase();
        } else if (column === 'provider') {
          aVal = a.dataset.deviceProvider.toLowerCase();
          bVal = b.dataset.deviceProvider.toLowerCase();
        } else if (column === 'model') {
          aVal = a.dataset.deviceModel.toLowerCase();
          bVal = b.dataset.deviceModel.toLowerCase();
        } else if (column === 'deviceId') {
          aVal = a.dataset.deviceId.toLowerCase();
          bVal = b.dataset.deviceId.toLowerCase();
        } else if (column === 'position') {
          aVal = parseInt(a.dataset.devicePosition);
          bVal = parseInt(b.dataset.devicePosition);
        }
        
        var comparison = 0;
        if (column === 'position') {
          comparison = aVal - bVal;
        } else {
          if (aVal > bVal) {
            comparison = 1;
          } else if (aVal < bVal) {
            comparison = -1;
          }
        }
        
        return sortDirection === 'asc' ? comparison : -comparison;
      });
      
      rows.forEach(function(row) {
        tbody.appendChild(row);
      });
      
      updateSortIndicators();
      filterDevices();
    }
    
    function updateSortIndicators() {
      document.querySelectorAll('.sortable-header').forEach(function(header) {
        var column = header.dataset.column;
        var indicator = header.querySelector('.sort-indicator');
        if (sortColumn === column) {
          indicator.textContent = sortDirection === 'asc' ? ' ▲' : ' ▼';
        } else {
          indicator.textContent = '';
        }
      });
    }
    
    window.onload = function() {
      filterDevices();
    };
  </script>
{% endblock %}

{% block content %}
  <div class="container">
    <a href="{{ url_for('index') }}" class="back-link">← Back to Dashboard</a>
    <h1>All Devices</h1>
    <p style="color: #a0a0a0; margin-bottom: 24px;">Complete inventory of all devices from Homebridge and Home Assistant.</p>
    
    <div class="card">
      <div style="margin-bottom: 16px;">
        <input type="text" id="search_input" placeholder="Search by name, provider, model, or device ID..." 
               style="width: 100%; padding: 10px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 4px; color: #ffffff; font-size: 0.9rem;"
               onkeyup="filterDevices()" oninput="filterDevices()">
      </div>
      
      <table id="devicesTable">
        <thead>
    <tr>
            <th class="sortable-header" data-column="position" onclick="sortTable('position')" style="cursor: pointer; user-select: none; width: 80px;">
              Position<span class="sort-indicator"></span>
            </th>
            <th class="sortable-header" data-column="name" onclick="sortTable('name')" style="cursor: pointer; user-select: none;">
              Name<span class="sort-indicator"></span>
            </th>
            <th class="sortable-header" data-column="provider" onclick="sortTable('provider')" style="cursor: pointer; user-select: none;">
              Provider<span class="sort-indicator"></span>
            </th>
            <th class="sortable-header" data-column="model" onclick="sortTable('model')" style="cursor: pointer; user-select: none;">
              Model<span class="sort-indicator"></span>
            </th>
            <th class="sortable-header" data-column="deviceId" onclick="sortTable('deviceId')" style="cursor: pointer; user-select: none;">
              Device ID<span class="sort-indicator"></span>
            </th>
    </tr>
        </thead>
        <tbody>
    {% for dev in enumerated_devices %}
      {% set uuid = dev[0] %}
      {% set details = dev[1] %}
            {% set device_name = details.get("name", "Unknown") %}
            {% set device_provider = details.get("provider", "unknown")|upper %}
            {% set device_model = (details.get("meta", {}) or {}).get("model", details.get("model", "Unknown")) %}
            <tr class="device-row"
                data-device-position="{{ loop.index }}"
                data-device-name="{{ device_name }}"
                data-device-provider="{{ device_provider }}"
                data-device-model="{{ device_model }}"
                data-device-id="{{ uuid }}">
              <td><strong>{{ loop.index }}</strong></td>
              <td>{{ device_name }}</td>
              <td>
                <span class="status-badge status-running" style="font-size: 0.7rem;">
                  {{ device_provider }}
                </span>
              </td>
              <td>{{ device_model }}</td>
              <td style="font-family: monospace; font-size: 0.85rem; color: #a0a0a0;">{{ uuid }}</td>
      </tr>
    {% endfor %}
        </tbody>
  </table>
    </div>
  </div>
{% endblock %}

